<%- title @recipe.title.html_safe %>
<% activate_nav!(:recipes) %>

<%= render 'shared/nav' %>

<div itemscope itemtype="http://schema.org/Recipe">
  <meta itemprop="url" content="<%= @shared_url %>" />
  <meta itemprop="dateCreated" content="<%= @recipe.created_at %>" />
  <meta itemprop="dateModified" content="<%= @recipe.updated_at %>" />

  <%= render 'image_header' if @image_layout %>

  <main class="document mw7">

    <% if !@image_layout %>
      <%= form_for(@recipe, 'data-remote': true, html: { class: 'dib dn-p fr' }) do |f| %>
        <label class="tooltipped man" aria-label="Favorite">
          <%= f.check_box :favorite, class: 'recipe__favorite__checkbox', 'data-behavior': 'recipe_favorite_trigger' %>
          <%= inline_svg 'favorite_outline.svg', class: 'fill-orange pointer recipe__favorite__indicator', size: 32 %>
          <%= inline_svg 'favorite.svg', class: 'fill-orange pointer recipe__favorite__indicator--checked', size: 32 %>
        </label>
      <% end %>

      <h1 class="man di" itemprop="name"><%= @recipe.title %></h1>
      <div class="text mtm" itemprop="description"><%= sanitize markdown @recipe.description.to_s %></div>

    <% end %>

    <%= render 'recipe_body' %>

    <%= render 'shared/social' if @recipe.shared? %>

    <div class="dn-p mts">
      <%= link_to t('general.edit'), :edit_recipe, class: 'btn bg-blue mrs mts' %>
      <a href="#collect" class="btn bg-orange mrs mts" data-behavior="modal_trigger">
        Add to Collection
        <%= "(#{@recipe.collections.count})" if @recipe.collections.any? %>
      </a>
      <a href="#share" class="btn bg-green mrs mts" data-behavior="modal_trigger">Share</a>
      <%= link_to t('general.delete'), @recipe, method: :delete, data: { confirm: t('general.delete_forever') }, class: 'btn bg-red mts' %>
    </div>

    <%= render 'shared/printer' %>

  </main>

</div>

<section id="collect" class="modal tc" role="dialog">
  <%= modal_close %>
  <h2 class="mtn mbs">Add to Collection</h2>

  <% @collections = current_user.collections %>
  <% if @collections.any? %>
    <p>Move this recipe to any of your collections by selecting them below.</p>
    <%= form_for(@recipe, html: { class: 'phm mtm' }) do |f| %>
      <ul class="list-reset mw5 mx-auto tl">
        <%= collection_check_boxes(:recipe, :collections, @collections, :id, :name) do |b| %>
          <li class="border-top">
            <%= b.label class: 'colladd__item man pas pointer' do %>
              <%= b.check_box checked: @recipe.collections.include?(b.value.to_s), class: 'colladd__item__check dn' %>
              <span class="colladd__item__label"><%= b.text.truncate 30 %></span>
              <%= inline_svg 'check.svg', class: 'colladd__item__mark fill-orange fr dn' %>
            <% end %>
          </li>
        <% end %>
        <li class="border-top border-bottom pas grey-1">
          <%= link_to 'Create New Collection...', collections_path(new_collection: true), class: 'link-reset' %>
        </li>
      </ul>
      <%= f.submit 'Save', class: 'btn bg-blue' %>
    <% end %>
  <% else %>
    <article class="text tc border bg-grey-6 rounded pal">
      <h3 class="mtn">You don't have any collections yet!</h3>
      <p>Collections help you organize your recipes.</p>
      <%= link_to 'Create a Collection', collections_path(new_collection: true), class: 'btn bg-green mts' %>
    </article>
  <% end %>
</section>

<section id="share" class="modal" role="dialog">
  <%= modal_header 'Share this recipe' %>

  <article class="tab-container">
    <input type="radio" name="tab-set-2" class="tab-1" id="tab-2-1" checked>
    <label for="tab-2-1" class="rounded-top dib border bg-grey-5">Share a link</label>

    <input type="radio" name="tab-set-2" class="tab-2" id="tab-2-2">
    <label for="tab-2-2" class="rounded-top dib border bg-grey-5">Download a PDF</label>

    <input type="radio" name="tab-set-2" class="tab-3" id="tab-2-3">
    <label for="tab-2-3" class="rounded-top dib border bg-grey-5">Embed on the Web</label>

    <br>

    <section class="content content-1 pas border rounded-bottom">
      <% if @recipe.shared? %>
      <p>Your recipe is already shared!</p>
      <p><%= link_to 'Check out the share page', @shared_url, class: 'btn bg-blue' %></p>
      <% else %>
      <p>Anyone with this link can see your recipe and save a copy to their own Noodles account.</p>
      <p><%= link_to 'Share a link to this recipe', recipe_share_it_path(@recipe), class: 'btn bg-blue' %></p>
      <% end %>
    </section>

    <section class="content content-2 pas border rounded-bottom">
      <p>Click the button below to download a PDF of your recipe.</p>
      <p><%= link_to 'Download PDF', recipe_export_pdf_path(@recipe), class: 'btn bg-blue' %></p>
    </section>

    <section class="content content-3 pas border rounded-bottom">
      <p>Copy and paste the code below onto your website or blog to embed this recipe.</p>
      <pre class="man pas border rounded bg-grey-6" style="white-space: inherit;">
        <%= '<script src="https://getnoodl.es/embed/' + @recipe.shared_id.to_s + '"></script>' %>
      </pre>
      <p class="mts"><%= link_to 'Need help?', help_path %></p>
    </section>
  </article>
</section>

<a class="btn-paper-mini bg-orange fill-white circle fixed pas pointer shadow tooltipped"
   aria-label="Print this recipe" data-behavior="print">
  <%= inline_svg 'print.svg' %>
</a>

<%= link_to recipe_cook_path(recipe_id: @recipe.id),
            class: 'btn-paper bg-orange fill-white circle fixed pam shadow tooltipped',
            'aria-label': 'Open Cook Mode' do %>
  <%= inline_svg 'cook.svg' %>
<% end %>
